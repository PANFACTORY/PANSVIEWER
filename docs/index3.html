<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PANSVIEWER</title>
</head>
<body>
    <h1>PANSVIEWER</h1>

    <div>
        <input type="file" id="input_file" onchange="onChangeFile()" />
    </div>

    <div>
        <canvas id="canvas" width="480" height="360"></canvas>
    </div>
    
    <div>
        <div>視点座標</div>
        <label>r<input type="number" id="input_radius" autocomplete="off" value="1" onchange="onChangeParams()" /></label>
        <label>θ<input type="number" id="input_theta" autocomplete="off" value="30" onchange="onChangeParams()" /></label>
        <label>φ<input type="number" id="input_phi" autocomplete="off" value="100" onchange="onChangeParams()" /></label>
    </div>

    <div>
        <div>注視点座標</div>
        <label>x<input type="number" id="input_ax" autocomplete="off" value="0" onchange="onChangeParams()" /></label>
        <label>y<input type="number" id="input_ay" autocomplete="off" value="0" onchange="onChangeParams()" /></label>
        <label>z<input type="number" id="input_az" autocomplete="off" value="0" onchange="onChangeParams()" /></label>
    </div>

    <div>
        <div>倍率</div>
        <label>h<input type="number" id="input_h" autocomplete="off" value="2" onchange="onChangeParams()" /></label>
        <label>r<input type="number" id="input_r" autocomplete="off" value="400" onchange="onChangeParams()" /></label>
    </div>

    <div>
        <div>色</div>
        <div>color<input type="color" id="input_c" value="#11E82B" onchange="onChangeParams()" /></div>
    </div>

    <script>
        function convertPOV(_r, _theta, _phi) {
            return { x : _r*Math.sin(_theta)*Math.cos(_phi), y : _r*Math.sin(_theta)*Math.sin(_phi), z : _r*Math.cos(_theta) };
        }

        function getParams() {
            return { 
                vertexf : convertPOV(
                    document.getElementById("input_radius").value, 
                    document.getElementById("input_theta").value*(Math.PI/180.0), 
                    document.getElementById("input_phi").value*(Math.PI/180.0)
                ),
                vertexa : { 
                    x : document.getElementById("input_ax").value, 
                    y : document.getElementById("input_ay").value, 
                    z : document.getElementById("input_az").value
                }, 
                h : document.getElementById("input_h").value, 
                r : document.getElementById("input_r").value,
            };
        }

        function drawObject(_canvas, _color, _obj) {
            const ctx = _canvas.getContext('2d');
            ctx.clearRect(0, 0, _canvas.width, _canvas.height);

            const TX = _canvas.width/2;
            const TY = _canvas.height/2;

            const R = parseInt(_color.substring(1, 3), 16);
            const G = parseInt(_color.substring(3, 5), 16);
            const B = parseInt(_color.substring(5, 7), 16);

            for (var face of _obj) {
                ctx.beginPath();
                ctx.moveTo(TX + face.X0, TY + face.Y0);
                ctx.lineTo(TX + face.X1, TY + face.Y1);
                ctx.lineTo(TX + face.X2, TY + face.Y2);
                ctx.closePath();
                ctx.strokeStyle = `rgb(${parseInt(R*face.shading)}, ${parseInt(G*face.shading)}, ${parseInt(B*face.shading)})`;
                ctx.stroke();
                ctx.fillStyle = `rgba(${parseInt(R*face.shading)}, ${parseInt(G*face.shading)}, ${parseInt(B*face.shading)}, 1.0)`;
                ctx.fill();
            }           
        }

        async function onChangeFile() {
            const files = document.getElementById('input_file').files;
            if (files.length) {
                let data = new FormData();
                data.append('params', JSON.stringify(getParams()));
                data.append('model', files[0], 'modelfile');

                let response = await fetch('http://localhost:7000/', {
                    method: 'POST',
                    body: data,
                });
                let result = await response.json();

                drawObject(document.getElementById('canvas'), document.getElementById('input_c').value, result);  
            }
        }

        async function onChangeParams() {
            let data = new FormData();
            data.append('params', JSON.stringify(getParams()));

            let response = await fetch('http://localhost:7000/params', {
                method: 'POST',
                body: data,
            });
            let result = await response.json();

            drawObject(document.getElementById('canvas'), document.getElementById('input_c').value, result);
        }
    </script>
</body>
</html>