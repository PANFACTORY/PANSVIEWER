<!DOCTYPE html>
<html>
<head>
    <title>PANSVIEWER</title>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
</head>
<body>
    <h1>PANSVIEWER</h1>

    <div>
        <input type="file" id="input_file" />
    </div>

    <div>
        <canvas id="canvas" width="480" height="360"></canvas>
    </div>
    
    <div>
        <div>視点座標</div>
        <label>r<input type="number" id="input_radius" autocomplete="off" value="1" onchange="onChangeParams()" /></label>
        <label>θ<input type="number" id="input_theta" autocomplete="off" value="30" onchange="onChangeParams()" /></label>
        <label>φ<input type="number" id="input_phi" autocomplete="off" value="100" onchange="onChangeParams()" /></label>
    </div>

    <div>
        <div>注視点座標</div>
        <label>x<input type="number" id="input_ax" autocomplete="off" value="0" onchange="onChangeParams()" /></label>
        <label>y<input type="number" id="input_ay" autocomplete="off" value="0" onchange="onChangeParams()" /></label>
        <label>z<input type="number" id="input_az" autocomplete="off" value="0" onchange="onChangeParams()" /></label>
    </div>

    <div>
        <div>倍率</div>
        <label>h<input type="number" id="input_h" autocomplete="off" value="2" onchange="onChangeParams()" /></label>
        <label>r<input type="number" id="input_r" autocomplete="off" value="400" onchange="onChangeParams()" /></label>
    </div>

    <div>
        <div>色</div>
        <div>color<input type="color" id="input_c" value="#11E82B" onchange="onChangeParams()" /></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const inputFile = document.getElementById('input_file');

        function drawObject(_canvas, _color, _obj) {
            const ctx = _canvas.getContext('2d');
            ctx.clearRect(0, 0, _canvas.width, _canvas.height);

            const TX = _canvas.width/2;
            const TY = _canvas.height/2;

            const R = parseInt(_color.substring(1, 3), 16);
            const G = parseInt(_color.substring(3, 5), 16);
            const B = parseInt(_color.substring(5, 7), 16);

            for (var face of _obj) {
                ctx.beginPath();
                ctx.moveTo(TX + face.X0, TY + face.Y0);
                ctx.lineTo(TX + face.X1, TY + face.Y1);
                ctx.lineTo(TX + face.X2, TY + face.Y2);
                ctx.closePath();
                ctx.strokeStyle = `rgb(${parseInt(R*face.shading)}, ${parseInt(G*face.shading)}, ${parseInt(B*face.shading)})`;
                ctx.stroke();
                ctx.fillStyle = `rgba(${parseInt(R*face.shading)}, ${parseInt(G*face.shading)}, ${parseInt(B*face.shading)}, 1.0)`;
                ctx.fill();
            }           
        }

        function convertPOV(_r, _theta, _phi) {
            return { x : _r*Math.sin(_theta)*Math.cos(_phi), y : _r*Math.sin(_theta)*Math.sin(_phi), z : _r*Math.cos(_theta) };
        }

        inputFile.addEventListener("change", function(e) {
            const reader = new FileReader();
            reader.readAsBinaryString(e.target.files[0]);

            const param = JSON.stringify({ 
                vertexf : convertPOV($('#input_radius').val(), $('#input_theta').val()*(Math.PI/180.0), $('#input_phi').val()*(Math.PI/180.0)),
                vertexa : { x : $('#input_ax').val(), y : $('#input_ay').val(), z : $('#input_az').val() }, 
                h : $('#input_h').val(), 
                r : $('#input_r').val(),
            });

            reader.onload = function() {
                $.ajax({
                    async: false,
                    url: 'http://localhost:7000/file',
                    type: 'post',
                    data: { "obj" : reader.result, "param" : param },
                    dataType: 'json',
                }).done(function(res){
                    drawObject(canvas, $('#input_c').val(), res);  
                });
            }
        }, false);

        function onChangeParams() {
            const param = JSON.stringify({ 
                vertexf : convertPOV($('#input_radius').val(), $('#input_theta').val()*(Math.PI/180.0), $('#input_phi').val()*(Math.PI/180.0)),
                vertexa : { x : $('#input_ax').val(), y : $('#input_ay').val(), z : $('#input_az').val() }, 
                h : $('#input_h').val(), 
                r : $('#input_r').val(),
            });
            
            $.ajax({
                async: false,
                url: 'http://localhost:7000/param',
                type: 'post',
                data: { "param" : param },
                dataType: 'json',
            }).done(function(res){
                drawObject(canvas, $('#input_c').val(), res);  
            });
        }
    </script>
</body>
</html>